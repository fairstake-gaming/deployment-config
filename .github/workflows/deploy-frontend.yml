name: Deploy Frontend Changes

on:
  repository_dispatch:
    types: [frontend-updated]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Deploy Frontend to VPS
      uses: appleboy/ssh-action@v0.1.7
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        key: ${{ secrets.VPS_SSH_KEY }}
        envs: DOMAIN_NAME,BACKEND_REPO,FRONTEND_REPO,MONGODB_URI,JWT_SECRET,SPORTS_ODDS_API_KEY,EMAIL_USER,EMAIL_PASS,SESSION_SECRET,CCP_APP_ID,CCP_APP_SECRET,CCP_MERCHANT_ID,CLOUDINARY_CLOUD_NAME,CLOUDINARY_API_KEY,CLOUDINARY_API_SECRET
        script: |
          export DOMAIN_NAME="${{ secrets.DOMAIN_NAME }}"
          export BACKEND_REPO="${{ secrets.BACKEND_REPO }}"
          export FRONTEND_REPO="${{ secrets.FRONTEND_REPO }}"
          export MONGODB_URI="${{ secrets.MONGODB_URI }}"
          export JWT_SECRET="${{ secrets.JWT_SECRET }}"
          export SPORTS_ODDS_API_KEY="${{ secrets.SPORTS_ODDS_API_KEY }}"
          export EMAIL_USER="${{ secrets.EMAIL_USER }}"
          export EMAIL_PASS="${{ secrets.EMAIL_PASS }}"
          export SESSION_SECRET="${{ secrets.SESSION_SECRET }}"
          export CCP_APP_ID="${{ secrets.CCP_APP_ID }}"
          export CCP_APP_SECRET="${{ secrets.CCP_APP_SECRET }}"
          export CCP_MERCHANT_ID="${{ secrets.CCP_MERCHANT_ID }}"
          export CLOUDINARY_CLOUD_NAME="${{ secrets.CLOUDINARY_CLOUD_NAME }}"
          export CLOUDINARY_API_KEY="${{ secrets.CLOUDINARY_API_KEY }}"
          export CLOUDINARY_API_SECRET="${{ secrets.CLOUDINARY_API_SECRET }}"
          cd /var/www/deployment-config
          git pull origin main
          chmod +x env-from-secrets.sh deploy-frontend.sh
          ./env-from-secrets.sh
          ./deploy-frontend.sh